import t from"axios";import e from"https";import r from"fs";import{v4 as s,v5 as i}from"uuid";import a from"md5";import n from"camelcase-keys";import o from"axios/lib/adapters/http";import c from"qrcode";function u(t){const e=t&&t.response,r=e&&parseInt(e.status,10),s={success:!1,statusHttp:r||0,messageError:t?`${t.code||t.message}`:"Timeout",responseError:e&&e.data?e.data:{},error:t};return e?(s.messageError=`httpError ${r}`,Promise.resolve({data:s})):Promise.resolve({data:s})}function h(t,e){return t&&t.length>e?t.substring(0,e):t}function l(t){return!("string"!=typeof t||!/^[a-zA-Z0-9]{26,35}$/.test(t))}function p(t){return!("string"!=typeof t||!/\d{1,10}\.\d{2}$/.test(t))}function g(t,e,r){if(!t)return"";if(Array.isArray(e)){let s=`${t}`;for(let t=0;t<e.length;t++)s=g(s,e[t],r);return s}return t.split(e).join(r)}function d(t){return!("object"!=typeof t||null===t||t instanceof RegExp||t instanceof Error||t instanceof Date||Array.isArray(t))}function f(t){return"string"==typeof t?parseInt(t,10).toString(16):t.toString(16)}function m(t,e="_"){return"string"==typeof t?t.replace(/([\p{Lowercase_Letter}\d])(\p{Uppercase_Letter})/gu,`$1${e}$2`).replace(/(\p{Uppercase_Letter}+)(\p{Uppercase_Letter}\p{Lowercase_Letter}+)/gu,`$1${e}$2`).toLowerCase():t}function y(t){const e={};return Object.keys(t).forEach((r=>{const s=m(r);e[s]=d(t[r])?y(t[r]):t[r]})),e}function $(t){return Array.isArray(t)?t.map((t=>$(t))):d(t)?y(t):m(`${t}`)}class A{constructor(t){this.logPrefix="ApiPix",this.Api=null,this.cancelSources=[],this.Agent=null,this.token="",this.config={timeout:3e3,debug:!1},this.set(t).configureAxios()}logging(...t){this.config.debug&&console.log(this.logPrefix,...t)}configureAxios(){return this.Api=t.create({baseURL:this.config.baseURL,timeout:this.config.timeout||1e4,adapter:o}),this.Api.defaults.headers={"Cache-Control":"no-cache",Pragma:"no-cache",Expires:"0","Content-Type":"application/json",Accept:"application/json"},this.configureRequests().configureResponses().setAgentSSL()}configureRequests(){return this.Api.interceptors.request.use((t=>(t.data&&t.decamelcase&&(t.data=$(t.data)),this.logging(`REQUEST ${t.method}: (${t.baseURL}${t.url})`,t.data),t))),this}configureResponses(){return this.Api.interceptors.response.use((t=>{const e=t&&t.data,r={status:t.status||t.data.status,success:!(!t.status||t.data.error),data:e?n(e,{deep:!0}):{}};return this.logging(`RESPONSE: (${t.config.baseURL}${t.config.url})`,e),{...t,...r}}),u),this}loadCertificate(t){const s=t=>{try{return new e.Agent(t)}catch(t){throw new TypeError(`Erro de certificado: ${t}`)}};if(t)return s(t);if(this.config.certificate){const{path:t,passphrase:e}=this.config.certificate;if(r.existsSync(t))return s({passphrase:e,pfx:r.readFileSync(t)});throw new TypeError(`Caminho do certificado: ${t}`)}return null}setAgentSSL(t){if(this.config.certificate){const e=this.loadCertificate(t);if(e)return this.Agent=e,this.Api.defaults.httpsAgent=e,this}return this}async getAccessToken(){const{clientId:t,clientSecret:e}=this.config,r=Buffer.from(`${t}:${e}`).toString("base64"),s=this.getCancelToken().source(),i=s.token;this.addCancelSource(s);const a={cancelToken:i,headers:{Authorization:`Basic ${r}`},httpsAgent:this.Agent,decamelcase:!0},n=await this.Api.post("/oauth/token",{grantType:"client_credentials"},a);if(this.removeCancelSource(i),n&&n.data){const t=n.data.accessToken||"";return this.token=t,n&&n.data}throw new TypeError("Erro ao adquirir token de acesso")}getCancelToken(){return t.CancelToken}removeCancelSource(t){if(t){const e=this.cancelSources.filter((({idToken:e})=>e!==t));return this.cancelSources=e||[],this}return this.cancelSources=[],this}addCancelSource(t){return this.cancelSources.push({idToken:t.token,source:t}),this}set(t,e){return d(t)?Object.keys(t).forEach((e=>this.config[e]=t[e])):this.config[t]=e,this}async init(){return await this.getAccessToken()}cancel(){return this.cancelSources.forEach((({source:t})=>{t&&t.cancel("canceled")})),this.removeCancelSource(),this}async requestApi(t,e,r,s){const i=this.getCancelToken().source(),a=i.token;this.addCancelSource(i),this.token||await this.getAccessToken();const{decamelcase:n,...o}=s||{},c=[e,r,s&&o?{...s,cancelToken:a}:{cancelToken:a,headers:{Authorization:`Bearer ${this.token}`},decamelcase:!!n}].filter((t=>!!t)),u=await this.Api[t.toLocaleLowerCase()](...c);return this.removeCancelSource(a),u}txidGenerate(t){if(t&&t.useMD5Timestamp){const t=(+new Date).toString(16);return a(`${this.config.baseURL}${t}`)}const e=t&&t.namespace||s();return g(i(this.config.baseURL,e),"-","")}async createCob(t,e){const r=e||this.txidGenerate(),s=await this.requestApi("put",`/v2/cob/${r}`,t);return s&&s.data}async consultCob(t){const e=await this.requestApi("get",`/v2/cob/${t}`);return e&&e.data}}const C="00",S="01",k="26",T="00",b="01",w="02",E="25",L="52",x="53",R="54",V="58",P="59",U="60",q="62",v="05",j="63",_={currency:"986",countryCode:"BR",categoryCode:"0000",pixKey:"",description:"",uniquePayment:!0,amount:"",merchantName:"",merchantCity:"Cidade",txid:"",isStatic:!1,url:""};class D{constructor(t){return this.payload=_,t&&this.set(t),this}set(t,e){return d(t)?Object.keys(t).forEach((e=>{e in this.payload&&(this.payload[e]=t[e])})):"string"==typeof t&&t in this.payload&&(this.payload[t]=e),this}getValue(t,e){return`${t}${`${`${e}`.length}`.padStart(2,"0")}${e}`}getMerchantAccountInformation(){const{url:t,pixKey:e,description:r,isStatic:s}=this.payload,i=[this.getValue(T,"br.gov.bcb.pix"),e&&s?this.getValue(b,e):"",r?this.getValue(w,(a=r,h(a,99-(22+(s?e.length:0))))):"",t&&!s?this.getValue(E,t.replace(/^(https?|ftp):\/\//,"")):""].filter((t=>!!t));var a;return this.getValue(k,`${i.join("")}`)}getUniquePayment(){return this.payload.uniquePayment?this.getValue(S,"12"):""}getAdditionalDataFieldTemplate(){const t=this.payload.isStatic?this.getValue(v,this.payload.txid):"***";return this.getValue(q,t)}getCRC16(t){return`${j}04${function(t){let e=65535;const r=String(t).length;for(let s=0;s<r;s++){e^=`${t[s]}`.charCodeAt(0)<<8;for(let t=0;t<8;t++)65536&(e<<=1)&&(e^=4129),e&=65535}return s=f(e),`${s}`.toLocaleUpperCase();var s}(`${t}${j}04`)}`}getPayload(){const{amount:t,merchantName:e,merchantCity:r,currency:s,countryCode:i,categoryCode:a}=this.payload,n=[this.getValue(C,"01"),this.getUniquePayment(),this.getMerchantAccountInformation(),this.getValue(L,a),this.getValue(x,s),this.getValue(R,t),this.getValue(V,i),this.getValue(P,e),this.getValue(U,r||"Cidade"),this.getAdditionalDataFieldTemplate()],o=n.join("");return`${n.join("")}${this.getCRC16(o)}`}async getQRCode(t=512){return await c.toDataURL(this.getPayload(),{width:t})}async save(t,e){return await c.toFile(t,this.getPayload(),e),this}}export{A as ApiPix,D as QRCodePayload,$ as decamelcase,f as dechex,g as replaceAll,h as stringLimit,l as validPixTxid,p as validPixValor};
//# sourceMappingURL=index.es.js.map
