import t from"axios";import e from"https";import r from"fs";import{v4 as i,v5 as a}from"uuid";import s from"md5";import n from"camelcase-keys";import o from"axios/lib/adapters/http";import c from"qrcode";function u(t){const e=t&&t.response,r=e&&parseInt(e.status,10),i={success:!1,statusHttp:r||0,messageError:t?`${t.code||t.message}`:"Timeout",responseError:e&&e.data?e.data:{},error:t};return e?(i.messageError=`httpError ${r}`,Promise.resolve({data:i})):Promise.resolve({data:i})}function h(t,e){return t&&t.length>e?t.substring(0,e):t}function l(t){return!("string"!=typeof t||!/^[a-zA-Z0-9]{26,35}$/.test(t))}function p(t){return!("string"!=typeof t||!/\d{1,10}\.\d{2}$/.test(t))}function g(t,e,r){if(!t)return"";if(Array.isArray(e)){let i=`${t}`;for(let t=0;t<e.length;t++)i=g(i,e[t],r);return i}return t.split(e).join(r)}function d(t){return!("object"!=typeof t||null===t||t instanceof RegExp||t instanceof Error||t instanceof Date||Array.isArray(t))}function f(t){return"string"==typeof t?parseInt(t,10).toString(16):t.toString(16)}function y(t,e="_"){return"string"==typeof t?t.replace(/([\p{Lowercase_Letter}\d])(\p{Uppercase_Letter})/gu,`$1${e}$2`).replace(/(\p{Uppercase_Letter}+)(\p{Uppercase_Letter}\p{Lowercase_Letter}+)/gu,`$1${e}$2`).toLowerCase():t}function m(t){const e={};return Object.keys(t).forEach((r=>{const i=y(r);e[i]=d(t[r])?m(t[r]):t[r]})),e}function C(t){return Array.isArray(t)?t.map((t=>C(t))):d(t)?m(t):y(`${t}`)}const $="00",A="01",S="26",b="00",x="01",k="02",w="25",R="52",T="53",L="54",E="58",v="59",P="60",U="62",V="05",q="63",j={currency:"986",countryCode:"BR",categoryCode:"0000",pixKey:"",description:"",uniquePayment:!0,amount:"",merchantName:"",merchantCity:"Cidade",txid:"",isStatic:!1,url:""};class _{constructor(t){return this.payload=j,t&&this.set(t),this}set(t,e){return d(t)?Object.keys(t).forEach((e=>{e in this.payload&&(this.payload[e]=t[e])})):"string"==typeof t&&t in this.payload&&(this.payload[t]=e),this}getValue(t,e){return`${t}${`${`${e}`.length}`.padStart(2,"0")}${e}`}getMerchantAccountInformation(){const{url:t,pixKey:e,description:r,isStatic:i}=this.payload,a=[this.getValue(b,"br.gov.bcb.pix"),e&&i?this.getValue(x,e):"",r?this.getValue(k,(s=r,h(s,99-(22+(i?e.length:0))))):"",t&&!i?this.getValue(w,t.replace(/^(https?|ftp):\/\//,"")):""].filter((t=>!!t));var s;return this.getValue(S,`${a.join("")}`)}getUniquePayment(){return this.payload.uniquePayment?this.getValue(A,"12"):""}getAdditionalDataFieldTemplate(){const t=this.payload.isStatic?this.getValue(V,this.payload.txid):"***";return this.getValue(U,t)}getCRC16(t){return`${q}04${function(t){let e=65535;const r=String(t).length;for(let i=0;i<r;i++){e^=`${t[i]}`.charCodeAt(0)<<8;for(let t=0;t<8;t++)65536&(e<<=1)&&(e^=4129),e&=65535}return i=f(e),`${i}`.toLocaleUpperCase();var i}(`${t}${q}04`)}`}getPayload(){const{amount:t,merchantName:e="",merchantCity:r="",currency:i,countryCode:a,categoryCode:s}=this.payload,n=[this.getValue($,"01"),this.getUniquePayment(),this.getMerchantAccountInformation(),this.getValue(R,s),this.getValue(T,i),this.getValue(L,t),this.getValue(E,a),this.getValue(v,e),this.getValue(P,r),this.getAdditionalDataFieldTemplate()],o=n.join("");return`${n.join("")}${this.getCRC16(o)}`}async getQRCode(t=512){return await c.toDataURL(this.getPayload(),{width:t})}async save(t,e){return await c.toFile(t,this.getPayload(),e),this}}function D(t,e){if(e)return e;return null!=t&&!!t?"https://api-pix-h.gerencianet.com.br":"https://api-pix.gerencianet.com.br"}class K{constructor(t){this.logPrefix="ApiPix",this.Api=null,this.cancelSources=[],this.Agent=null,this.token="";const{dev:e,baseURL:r}=t;this.config={timeout:3e3,debug:!1,baseURL:D(e,r)},this.set({...t,baseURL:D(e,r)}).configureAxios()}logging(...t){this.config.debug&&console.log(this.logPrefix,...t)}configureAxios(){return this.Api=t.create({baseURL:this.config.baseURL,timeout:this.config.timeout||1e4,adapter:o}),this.Api.defaults.headers={"Cache-Control":"no-cache",Pragma:"no-cache",Expires:"0","Content-Type":"application/json",Accept:"application/json"},this.configureRequests().configureResponses().setAgentSSL()}configureRequests(){return this.Api.interceptors.request.use((t=>(t.data&&t.decamelcase&&(t.data=C(t.data)),this.logging(`REQUEST ${t.method}: (${t.baseURL}${t.url})`,t.data),t))),this}configureResponses(){return this.Api.interceptors.response.use((t=>{const e=t&&t.data,r={status:t.status||t.data.status,success:!(!t.status||t.data.error),data:e?n(e,{deep:!0}):{}};return this.logging(`RESPONSE: (${t.config.baseURL}${t.config.url})`,e),{...t,...r}}),u),this}loadCertificate(t){const i=t=>{try{return new e.Agent(t)}catch(t){throw new TypeError(`Erro de certificado: ${t}`)}};if(t)return i(t);if(this.config.certificate){const{path:t,passphrase:e}=this.config.certificate;if(r.existsSync(t))return i({passphrase:e,pfx:r.readFileSync(t)});throw new TypeError(`Caminho do certificado: ${t}`)}return null}setAgentSSL(t){if(this.config.certificate){const e=this.loadCertificate(t);if(e)return this.Agent=e,this.Api.defaults.httpsAgent=e,this}return this}async getAccessToken(){const{clientId:t,clientSecret:e}=this.config,r=Buffer.from(`${t}:${e}`).toString("base64"),i=this.getCancelToken().source(),a=i.token;this.addCancelSource(i);const s={cancelToken:a,headers:{Authorization:`Basic ${r}`},httpsAgent:this.Agent,decamelcase:!0},n=await this.Api.post("/oauth/token",{grantType:"client_credentials"},s);if(this.removeCancelSource(a),n&&n.data){const t=n.data.accessToken||"";return this.token=t,n&&n.data}throw new TypeError("Erro ao adquirir token de acesso")}getCancelToken(){return t.CancelToken}removeCancelSource(t){if(t){const e=this.cancelSources.filter((({idToken:e})=>e!==t));return this.cancelSources=e||[],this}return this.cancelSources=[],this}addCancelSource(t){return this.cancelSources.push({idToken:t.token,source:t}),this}set(t,e){return d(t)?Object.keys(t).forEach((e=>this.config[e]=t[e])):this.config[t]=e,this}async init(){return await this.getAccessToken()}cancel(){return this.cancelSources.forEach((({source:t})=>{t&&t.cancel("canceled")})),this.removeCancelSource(),this}async requestApi(t,e,r,i){const a=this.getCancelToken().source(),s=a.token;this.addCancelSource(a),this.token||await this.getAccessToken();const{decamelcase:n,...o}=i||{},c=[e,r,i&&o?{...i,cancelToken:s}:{cancelToken:s,headers:{Authorization:`Bearer ${this.token}`},decamelcase:!!n}].filter((t=>!!t)),u=await this.Api[t.toLocaleLowerCase()](...c);return this.removeCancelSource(s),u}txidGenerate(t){if(t&&t.useMD5Timestamp){const t=(+new Date).toString(16);return s(`${this.config.baseURL}${t}`)}const e=t&&t.namespace||i();return g(a(this.config.baseURL,e),"-","")}createQRCodePayload(t,e){const{pixKey:r,merchantName:i,merchantCity:a,isStatic:s}=e,n=t.chave||r||this.config?.pixKey;return new _({pixKey:n,amount:t.valor.original,txid:t.txid,uniquePayment:!0,url:t.location,merchantName:i,merchantCity:a,isStatic:!(!r||!s)})}async createCob(t,e){const r=e||this.txidGenerate(),i=t.chave||this.config.pixKey;if(!i)throw new TypeError("chave pix não está presente");const a=await this.requestApi("put",`/v2/cob/${r}`,{...t,chave:i}),s=a&&a.data;return s&&!s.error&&(s.useQRCode=async(t={})=>{const{width:e,...r}=t,i=this.createQRCodePayload(s,{...r});return{base64:await i.getQRCode(e),payload:i.getPayload()}}),s}async consultCob(t){const e=await this.requestApi("get",`/v2/cob/${t}`);return e&&e.data}}export{K as ApiPix,_ as QRCodePayload,C as decamelcase,f as dechex,g as replaceAll,h as stringLimit,l as validPixTxid,p as validPixValor};
//# sourceMappingURL=index.es.js.map
