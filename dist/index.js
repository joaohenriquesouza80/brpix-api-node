"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("axios"),t=require("https"),r=require("fs"),a=require("uuid"),i=require("md5"),s=require("camelcase-keys"),n=require("axios/lib/adapters/http"),o=require("qrcode");function c(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var u=c(e),h=c(t),l=c(r),d=c(i),p=c(s),g=c(n),f=c(o);function y(e){const t=e&&e.response,r=t&&parseInt(t.status,10),a={success:!1,statusHttp:r||0,messageError:e?`${e.code||e.message}`:"Timeout",responseError:t&&t.data?t.data:{},error:e};return t?(a.messageError=`httpError ${r}`,Promise.resolve({data:a})):Promise.resolve({data:a})}function m(e,t){return e&&e.length>t?e.substring(0,t):e}function A(e,t,r){if(!e)return"";if(Array.isArray(t)){let a=`${e}`;for(let e=0;e<t.length;e++)a=A(a,t[e],r);return a}return e.split(t).join(r)}function C(e){return!("object"!=typeof e||null===e||e instanceof RegExp||e instanceof Error||e instanceof Date||Array.isArray(e))}function x(e){return"string"==typeof e?parseInt(e,10).toString(16):e.toString(16)}function $(e,t="_"){return"string"==typeof e?e.replace(/([\p{Lowercase_Letter}\d])(\p{Uppercase_Letter})/gu,`$1${t}$2`).replace(/(\p{Uppercase_Letter}+)(\p{Uppercase_Letter}\p{Lowercase_Letter}+)/gu,`$1${t}$2`).toLowerCase():e}function S(e){const t={};return Object.keys(e).forEach((r=>{const a=$(r);t[a]=C(e[r])?S(e[r]):e[r]})),t}function b(e){return Array.isArray(e)?e.map((e=>b(e))):C(e)?S(e):$(`${e}`)}const k="00",w="01",R="26",v="00",T="01",L="02",P="25",q="52",E="53",U="54",V="58",j="59",_="60",Q="62",D="05",K="63",I={currency:"986",countryCode:"BR",categoryCode:"0000",pixKey:"",description:"",uniquePayment:!0,amount:"",merchantName:"",merchantCity:"Cidade",txid:"",isStatic:!1,url:""};class N{constructor(e){return this.payload=I,e&&this.set(e),this}set(e,t){return C(e)?Object.keys(e).forEach((t=>{t in this.payload&&(this.payload[t]=e[t])})):"string"==typeof e&&e in this.payload&&(this.payload[e]=t),this}getValue(e,t){return`${e}${`${`${t}`.length}`.padStart(2,"0")}${t}`}getMerchantAccountInformation(){const{url:e,pixKey:t,description:r,isStatic:a}=this.payload,i=[this.getValue(v,"br.gov.bcb.pix"),t&&a?this.getValue(T,t):"",r?this.getValue(L,(s=r,m(s,99-(22+(a?t.length:0))))):"",e&&!a?this.getValue(P,e.replace(/^(https?|ftp):\/\//,"")):""].filter((e=>!!e));var s;return this.getValue(R,`${i.join("")}`)}getUniquePayment(){return this.payload.uniquePayment?this.getValue(w,"12"):""}getAdditionalDataFieldTemplate(){const e=this.payload.isStatic?this.getValue(D,this.payload.txid):"***";return this.getValue(Q,e)}getCRC16(e){return`${K}04${function(e){let t=65535;const r=String(e).length;for(let a=0;a<r;a++){t^=`${e[a]}`.charCodeAt(0)<<8;for(let e=0;e<8;e++)65536&(t<<=1)&&(t^=4129),t&=65535}return a=x(t),`${a}`.toLocaleUpperCase();var a}(`${e}${K}04`)}`}getPayload(){const{amount:e,merchantName:t="",merchantCity:r="",currency:a,countryCode:i,categoryCode:s}=this.payload,n=[this.getValue(k,"01"),this.getUniquePayment(),this.getMerchantAccountInformation(),this.getValue(q,s),this.getValue(E,a),this.getValue(U,e),this.getValue(V,i),this.getValue(j,t),this.getValue(_,r),this.getAdditionalDataFieldTemplate()],o=n.join("");return`${n.join("")}${this.getCRC16(o)}`}async getQRCode(e=512){return await f.default.toDataURL(this.getPayload(),{width:e})}async save(e,t){return await f.default.toFile(e,this.getPayload(),t),this}}function O(e,t){if(t)return t;return null!=e&&!!e?"https://api-pix-h.gerencianet.com.br":"https://api-pix.gerencianet.com.br"}exports.ApiPix=class{constructor(e){this.logPrefix="ApiPix",this.Api=null,this.cancelSources=[],this.Agent=null,this.token="";const{dev:t,baseURL:r}=e;this.config={timeout:3e3,debug:!1,baseURL:O(t,r)},this.set({...e,baseURL:O(t,r)}).configureAxios()}logging(...e){this.config.debug&&console.log(this.logPrefix,...e)}configureAxios(){return this.Api=u.default.create({baseURL:this.config.baseURL,timeout:this.config.timeout||1e4,adapter:g.default}),this.Api.defaults.headers={"Cache-Control":"no-cache",Pragma:"no-cache",Expires:"0","Content-Type":"application/json",Accept:"application/json"},this.configureRequests().configureResponses().setAgentSSL()}configureRequests(){return this.Api.interceptors.request.use((e=>(e.data&&e.decamelcase&&(e.data=b(e.data)),this.logging(`REQUEST ${e.method}: (${e.baseURL}${e.url})`,e.data),e))),this}configureResponses(){return this.Api.interceptors.response.use((e=>{const t=e&&e.data,r={status:e.status||e.data.status,success:!(!e.status||e.data.error),data:t?p.default(t,{deep:!0}):{}};return this.logging(`RESPONSE: (${e.config.baseURL}${e.config.url})`,t),{...e,...r}}),y),this}loadCertificate(e){const t=e=>{try{return new h.default.Agent(e)}catch(e){throw new TypeError(`Erro de certificado: ${e}`)}};if(e)return t(e);if(this.config.certificate){const{path:e,passphrase:r}=this.config.certificate;if(l.default.existsSync(e))return t({passphrase:r,pfx:l.default.readFileSync(e)});throw new TypeError(`Caminho do certificado: ${e}`)}return null}setAgentSSL(e){if(this.config.certificate){const t=this.loadCertificate(e);if(t)return this.Agent=t,this.Api.defaults.httpsAgent=t,this}return this}async getAccessToken(){const{clientId:e,clientSecret:t}=this.config,r=Buffer.from(`${e}:${t}`).toString("base64"),a=this.getCancelToken().source(),i=a.token;this.addCancelSource(a);const s={cancelToken:i,headers:{Authorization:`Basic ${r}`},httpsAgent:this.Agent,decamelcase:!0},n=await this.Api.post("/oauth/token",{grantType:"client_credentials"},s);if(this.removeCancelSource(i),n&&n.data){const e=n.data.accessToken||"";return this.token=e,n&&n.data}throw new TypeError("Erro ao adquirir token de acesso")}getCancelToken(){return u.default.CancelToken}removeCancelSource(e){if(e){const t=this.cancelSources.filter((({idToken:t})=>t!==e));return this.cancelSources=t||[],this}return this.cancelSources=[],this}addCancelSource(e){return this.cancelSources.push({idToken:e.token,source:e}),this}set(e,t){return C(e)?Object.keys(e).forEach((t=>this.config[t]=e[t])):this.config[e]=t,this}async init(){return await this.getAccessToken()}cancel(){return this.cancelSources.forEach((({source:e})=>{e&&e.cancel("canceled")})),this.removeCancelSource(),this}async requestApi(e,t,r,a){const i=this.getCancelToken().source(),s=i.token;this.addCancelSource(i),this.token||await this.getAccessToken();const{decamelcase:n,...o}=a||{},c=[t,r,a&&o?{...a,cancelToken:s}:{cancelToken:s,headers:{Authorization:`Bearer ${this.token}`},decamelcase:!!n}].filter((e=>!!e)),u=await this.Api[e.toLocaleLowerCase()](...c);return this.removeCancelSource(s),u}txidGenerate(e){if(e&&e.useMD5Timestamp){const e=(+new Date).toString(16);return d.default(`${this.config.baseURL}${e}`)}const t=e&&e.namespace||a.v4();return A(a.v5(this.config.baseURL,t),"-","")}createQRCodePayload(e,t){const{pixKey:r,merchantName:a,merchantCity:i,isStatic:s}=t,n=e.chave||r||this.config?.pixKey;return new N({pixKey:n,amount:e.valor.original,txid:e.txid,uniquePayment:!0,url:e.location,merchantName:a,merchantCity:i,isStatic:!(!r||!s)})}async createCob(e,t){const r=t||this.txidGenerate(),a=e.chave||this.config.pixKey;if(!a)throw new TypeError("chave pix não está presente");const i=await this.requestApi("put",`/v2/cob/${r}`,{...e,chave:a}),s=i&&i.data;return s&&!s.error&&(s.useQRCode=async(e={})=>{const{width:t,...r}=e,a=this.createQRCodePayload(s,{...r});return{base64:await a.getQRCode(t),payload:a.getPayload()}}),s}async consultCob(e){const t=await this.requestApi("get",`/v2/cob/${e}`);return t&&t.data}},exports.QRCodePayload=N,exports.decamelcase=b,exports.dechex=x,exports.replaceAll=A,exports.stringLimit=m,exports.validPixTxid=function(e){return!("string"!=typeof e||!/^[a-zA-Z0-9]{26,35}$/.test(e))},exports.validPixValor=function(e){return!("string"!=typeof e||!/\d{1,10}\.\d{2}$/.test(e))};
//# sourceMappingURL=index.js.map
